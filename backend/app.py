import os
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'
os.environ['OMP_NUM_THREADS'] = '1'

from fastapi import FastAPI, File, UploadFile
from fastapi.middleware.cors import CORSMiddleware
import numpy as np
from PIL import Image
import tensorflow as tf
import io

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 1. ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
model = None
MODEL_FILENAME = "trash_classifier_b3_pro.keras" # ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

print(f"‚è≥ Loading {MODEL_FILENAME}...")
try:
    model = tf.keras.models.load_model(MODEL_FILENAME, compile=False)
    print("‚úÖ Model Loaded Successfully!")
except Exception as e:
    print(f"‚ùå Error loading model: {e}")

# 2. ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ 20 Class (‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö!)
raw_class_names = [
    "battery",          # 0
    "brown-glass",      # 1
    "cardboard",        # 2
    "carton-drink",     # 3
    "cigarette",        # 4
    "clothes",          # 5
    "e-waste",          # 6
    "food-waste",       # 7
    "glass",            # 8
    "green-glass",      # 9
    "metal-can",        # 10
    "paper",            # 11
    "plastic-bag",      # 12
    "plastic-bottle",   # 13
    "plastic-cup",      # 14
    "shoes",            # 15
    "spray-cans",       # 16
    "styrofoam",        # 17
    "trash-general",    # 18
    "white-glass"       # 19
]

# =========================================================
# üî• 3. ‡∏£‡∏∞‡∏ö‡∏ö Super Grouping (‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏¢‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡πÄ‡∏Ç‡πà‡∏á)
# =========================================================
def get_trash_info(label):
    
    # üî¥ ‡∏Å‡∏•‡∏∏‡πà‡∏° 1: ‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ (Hazardous)
    # ‡∏£‡∏ß‡∏°: ‡∏ñ‡πà‡∏≤‡∏ô, ‡∏Ç‡∏¢‡∏∞‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå, ‡∏™‡πÄ‡∏õ‡∏£‡∏¢‡πå, ‡∏Å‡πâ‡∏ô‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà
    if label in ["battery", "e-waste", "spray-cans", "cigarette"]:
        return {
            "title": "‚õî ‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ (Hazardous)",
            "bin": "üî¥ ‡∏ñ‡∏±‡∏á‡πÅ‡∏î‡∏á (‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢)",
            "advice": "‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡∏£‡∏ß‡∏°‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡πÅ‡∏¢‡∏Å‡πÉ‡∏™‡πà‡∏ñ‡∏∏‡∏á‡πÅ‡∏î‡∏á/‡∏Ç‡∏ß‡∏î‡∏õ‡∏¥‡∏î‡∏ù‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏¢‡∏∞‡∏û‡∏¥‡∏©"
        }

    # üü° ‡∏Å‡∏•‡∏∏‡πà‡∏° 2: ‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• - ‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å (Plastic Recycle)
    # ‡∏£‡∏ß‡∏°: ‡∏Ç‡∏ß‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å, ‡πÅ‡∏Å‡πâ‡∏ß‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å
    elif label in ["plastic-bottle", "plastic-cup"]:
        return {
            "title": "‚ôªÔ∏è ‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å ‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• (Plastic)",
            "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)",
            "advice": "‡πÄ‡∏ó‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß‡∏≠‡∏≠‡∏Å ‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏ö‡∏µ‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•"
        }

    # üü° ‡∏Å‡∏•‡∏∏‡πà‡∏° 3: ‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• - ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© (Paper Recycle)
    # ‡∏£‡∏ß‡∏°: ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©, ‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©, ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏°
    elif label in ["paper", "cardboard", "carton-drink"]:
        return {
            "title": "‚ôªÔ∏è ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©/‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏° (Paper)",
            "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)",
            "advice": "‡∏û‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥/‡∏Ñ‡∏£‡∏≤‡∏ö‡∏°‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡∏°‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)"
        }

    # üü°/üü¢ ‡∏Å‡∏•‡∏∏‡πà‡∏° 4: ‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• - ‡πÅ‡∏Å‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡πÇ‡∏•‡∏´‡∏∞ (Glass & Metal)
    # ‡∏£‡∏ß‡∏°: ‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á, ‡πÅ‡∏Å‡πâ‡∏ß‡∏ó‡∏∏‡∏Å‡∏™‡∏µ
    elif label in ["metal-can", "glass", "brown-glass", "green-glass", "white-glass"]:
        return {
            "title": "‚ôªÔ∏è ‡πÅ‡∏Å‡πâ‡∏ß/‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á (Glass/Metal)",
            "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á / üü¢ ‡∏à‡∏∏‡∏î‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß",
            "advice": "‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á: ‡∏ö‡∏µ‡∏ö‡πÅ‡∏ö‡∏ô / ‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß: ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏ï‡∏Å (‡∏ñ‡πâ‡∏≤‡πÅ‡∏ï‡∏Å‡πÉ‡∏´‡πâ‡∏´‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏´‡∏ô‡∏≤‡πÜ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏Å‡πâ‡∏ß)"
        }

    # üü¢ ‡∏Å‡∏•‡∏∏‡πà‡∏° 5: ‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å (Organic)
    # ‡∏£‡∏ß‡∏°: ‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£
    elif label in ["food-waste"]:
        return {
            "title": "üçÇ ‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å/‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (Organic)",
            "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å)",
            "advice": "‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Å‡∏á‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î ‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏°‡∏±‡∏Å‡∏õ‡∏∏‡πã‡∏¢"
        }

    # üîµ ‡∏Å‡∏•‡∏∏‡πà‡∏° 6: ‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General Waste) - ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!
    # ‡∏£‡∏ß‡∏°: ‡πÇ‡∏ü‡∏°, ‡∏ñ‡∏∏‡∏á‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å, ‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ, ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤, ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤
    # üî• ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤ AI ‡∏ó‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡πÉ‡∏ô‡∏ô‡∏µ‡πâ ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏ß‡πà‡∏≤ "‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!
    elif label in ["styrofoam", "trash-general", "plastic-bag", "clothes", "shoes"]:
        return {
            "title": "üóëÔ∏è ‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General Waste)",
            "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)",
            "advice": "‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô, ‡∏ñ‡∏∏‡∏á‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å, ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÇ‡∏ü‡∏°, ‡∏ã‡∏≠‡∏á‡∏Ç‡∏ô‡∏°: ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ô‡∏µ‡πâ (‡∏ù‡∏±‡∏á‡∏Å‡∏•‡∏ö)\n‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á: ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô Power Bank/‡∏ñ‡πà‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡πÅ‡∏î‡∏á!"
        }
    
    # ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏•‡∏∏‡∏î‡∏£‡∏≠‡∏î (Fallback)
    else:
        return {
            "title": "üóëÔ∏è ‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General Waste)",
            "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)",
            "advice": "‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô"
        }

@app.post("/predict")
async def predict(file: UploadFile = File(...)):
    if model is None: return {"error": "Model not loaded"}
    
    try:
        # 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ
        image = Image.open(io.BytesIO(await file.read())).convert("RGB")
        w, h = image.size
        dim = min(w, h)
        image = image.crop(((w-dim)/2, (h-dim)/2, (w+dim)/2, (h+dim)/2))
        
        # Resize 300x300 (EfficientNet-B3)
        img_arr = np.array(image.resize((300, 300)))
        img_arr = np.expand_dims(img_arr, axis=0)

        # 2. ‡∏ó‡∏≤‡∏¢‡∏ú‡∏•
        pred = model.predict(img_arr, verbose=0)[0]
        idx = int(np.argmax(pred))
        conf = float(pred[idx]) * 100
        raw_label = raw_class_names[idx]

        # 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à (60%)
        if conf < 60.0:
            return {
                "prediction": "Unknown",
                "prediction_th": "‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à (Try Again)",
                "confidence": round(conf, 2),
                "bin": "‚ùì ‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà",
                "advice": "‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î ‡∏´‡∏£‡∏∑‡∏≠ AI ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‡∏•‡∏≠‡∏á‡∏Ç‡∏¢‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÜ ‡∏Ñ‡∏£‡∏±‡∏ö"
            }

        # 4. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° (Super Grouping)
        info = get_trash_info(raw_label)

        return {
            "prediction": raw_label,       # ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏î‡∏π log ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)
            "prediction_th": info["title"], # ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡πÇ‡∏ä‡∏ß‡πå User)
            "confidence": round(conf, 2),
            "bin": info["bin"],
            "advice": info["advice"]
        }

    except Exception as e:
        return {"error": str(e)}

@app.get("/")
def health(): return {"status": "Running", "model": "EfficientNet-B3 Super Grouping"}