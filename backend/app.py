import os
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î RAM (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Hugging Face Free Tier)
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'
os.environ['OMP_NUM_THREADS'] = '1'
os.environ['TF_NUM_INTRAOP_THREADS'] = '1'
os.environ['TF_NUM_INTEROP_THREADS'] = '1'

from fastapi import FastAPI, File, UploadFile
from fastapi.middleware.cors import CORSMiddleware
import numpy as np
from PIL import Image
import tensorflow as tf
import io

app = FastAPI()

# ‡πÄ‡∏õ‡∏¥‡∏î CORS ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
model = None
print("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• God Mode...")
try:
    # ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
    model = tf.keras.models.load_model("trash_classifier_god.keras", compile=False)
    print("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!")
except Exception as e:
    print(f"‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")

# üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ 19 Class (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
# ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà Colab print ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ï‡∏≠‡∏ô‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
class_names = [
    "battery",          # ‡∏ñ‡πà‡∏≤‡∏ô
    "brown-glass",      # ‡πÅ‡∏Å‡πâ‡∏ß‡∏™‡∏µ‡∏ä‡∏≤
    "cardboard",        # ‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©
    "carton-drink",     # ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏° (‡πÅ‡∏¢‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà)
    "cigarette",        # ‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà (‡πÅ‡∏¢‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà)
    "clothes",          # ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤
    "food-waste",       # ‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å
    "glass",            # ‡πÅ‡∏Å‡πâ‡∏ß‡∏£‡∏ß‡∏°/‡πÄ‡∏®‡∏©‡πÅ‡∏Å‡πâ‡∏ß
    "green-glass",      # ‡πÅ‡∏Å‡πâ‡∏ß‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    "metal-can",        # ‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á (‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡πÄ‡∏õ‡∏£‡∏¢‡πå)
    "paper",            # ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©
    "plastic-bag",      # ‡∏ñ‡∏∏‡∏á‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å (‡πÅ‡∏¢‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà)
    "plastic-bottle",   # ‡∏Ç‡∏ß‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å
    "plastic-cup",      # ‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å (‡πÅ‡∏¢‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà)
    "shoes",            # ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤
    "spray-cans",       # ‡∏™‡πÄ‡∏õ‡∏£‡∏¢‡πå (‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢!)
    "styrofoam",        # ‡πÇ‡∏ü‡∏° (‡πÅ‡∏¢‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà)
    "trash-general",    # ‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    "white-glass"       # ‡πÅ‡∏Å‡πâ‡∏ß‡πÉ‡∏™
]

# üí° ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏™‡∏°‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ)
# ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡∏ß‡πà‡∏≤‡∏Ç‡∏¢‡∏∞‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏±‡∏á‡πÑ‡∏á
trash_data = {
    # üî¥ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ (Dangerous)
    "spray-cans": {
        "th": "‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á‡∏™‡πÄ‡∏õ‡∏£‡∏¢‡πå/‡∏™‡∏µ", 
        "bin": "üî¥ ‡∏ñ‡∏±‡∏á‡πÅ‡∏î‡∏á (‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢)", 
        "advice": "‚õî ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏à‡∏≤‡∏∞ ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏∏‡∏ö ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ú‡∏≤ ‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡πÉ‡∏™‡πà‡∏ñ‡∏∏‡∏á‡πÅ‡∏î‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏¥‡πâ‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏¢‡∏∞‡∏û‡∏¥‡∏©"
    },
    "battery": {
        "th": "‡∏ñ‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏â‡∏≤‡∏¢/‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà", 
        "bin": "üî¥ ‡∏ñ‡∏±‡∏á‡πÅ‡∏î‡∏á (‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢)", 
        "advice": "‚õî ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏°‡∏µ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡πÑ‡∏î‡πâ ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ç‡∏¢‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î"
    },
    "cigarette": {
        "th": "‡∏Å‡πâ‡∏ô‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà", 
        "bin": "‚ö´ ‡∏Ç‡∏¢‡∏∞‡∏û‡∏¥‡∏©/‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", 
        "advice": "üö¨ ‡∏î‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏¥‡∏ó! ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏™‡πà‡∏Ç‡∏ß‡∏î‡πÅ‡∏¢‡∏Å‡∏ó‡∏¥‡πâ‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡∏≤‡∏£‡∏û‡∏¥‡∏©‡∏•‡∏á‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ (‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡∏•‡∏á‡∏ó‡πà‡∏≠)"
    },

    # ‚ôªÔ∏è ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• (Recycle)
    "carton-drink": {
        "th": "‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏°/‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ (UHT)", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "‚ôªÔ∏è ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏¥‡πâ‡∏á: ‡∏ï‡∏±‡∏î-‡∏•‡πâ‡∏≤‡∏á-‡∏ï‡∏≤‡∏Å-‡∏û‡∏±‡∏ö‡πÅ‡∏ö‡∏ô ‡∏™‡πà‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÑ‡∏î‡πâ"
    },
    "metal-can": {
        "th": "‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "‚ôªÔ∏è ‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏µ‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà"
    },
    "plastic-bottle": {
        "th": "‡∏Ç‡∏ß‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å (PET)", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "‚ôªÔ∏è ‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å ‡∏ö‡∏µ‡∏ö‡∏Ç‡∏ß‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ô (‡πÅ‡∏¢‡∏Å‡∏ù‡∏≤‡∏Å‡∏±‡∏ö‡∏Ç‡∏ß‡∏î‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ)"
    },
    "plastic-cup": {
        "th": "‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "ü•§ ‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏≠‡∏≠‡∏Å ‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î (‡∏´‡∏•‡∏≠‡∏î‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)"
    },
    "cardboard": {
        "th": "‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©/‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "üì¶ ‡∏Å‡∏£‡∏µ‡∏î‡πÄ‡∏ó‡∏õ‡∏Å‡∏≤‡∏ß‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥"
    },
    "paper": {
        "th": "‡πÄ‡∏®‡∏©‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "üìÑ ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏ñ‡∏∏‡∏á ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡∏Ñ‡∏£‡∏≤‡∏ö‡∏°‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£"
    },
    "brown-glass": {"th": "‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß‡∏™‡∏µ‡∏ä‡∏≤", "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß)", "advice": "üçæ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏™‡πà‡∏á‡∏Ç‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤"},
    "green-glass": {"th": "‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß)", "advice": "üçæ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏ï‡∏Å"},
    "white-glass": {"th": "‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß‡πÉ‡∏™", "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß)", "advice": "üçæ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏ï‡∏Å"},
    "glass": {"th": "‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß/‡πÄ‡∏®‡∏©‡πÅ‡∏Å‡πâ‡∏ß", "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß)", "advice": "‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏ï‡∏Å! (‡∏ñ‡πâ‡∏≤‡πÅ‡∏ï‡∏Å‡πÉ‡∏´‡πâ‡∏´‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏´‡∏ô‡∏≤‡πÜ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ß‡πà‡∏≤ '‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏Å‡πâ‡∏ß‡πÅ‡∏ï‡∏Å')"},

    # üóëÔ∏è ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏¢‡∏≤‡∏Å (General)
    "styrofoam": {
        "th": "‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÇ‡∏ü‡∏°/‡πÄ‡∏®‡∏©‡πÇ‡∏ü‡∏°", 
        "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)", 
        "advice": "‚õî ‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏•‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ! ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ú‡∏≤(‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡πä‡∏≤‡∏ã‡∏û‡∏¥‡∏©) ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
    },
    "plastic-bag": {
        "th": "‡∏ñ‡∏∏‡∏á‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å/‡∏ã‡∏≠‡∏á‡∏Ç‡∏ô‡∏°", 
        "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)", 
        "advice": "üóëÔ∏è ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ñ‡∏∏‡∏á‡∏¢‡∏∑‡∏î‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏™‡πà‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡πÑ‡∏î‡πâ)"
    },
    "trash-general": {
        "th": "‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", 
        "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)", 
        "advice": "üóëÔ∏è ‡∏Ç‡∏¢‡∏∞‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å/‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô/‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
    },
    "shoes": {
        "th": "‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤", 
        "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)", 
        "advice": "üëü ‡∏ñ‡πâ‡∏≤‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡∏û‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
    },
    "clothes": {
        "th": "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤", 
        "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)", 
        "advice": "üëï ‡∏ñ‡πâ‡∏≤‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏≥‡∏ú‡πâ‡∏≤‡∏Ç‡∏µ‡πâ‡∏£‡∏¥‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
    },
    
    # üçÇ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å (Organic)
    "food-waste": {
        "th": "‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å", 
        "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å)", 
        "advice": "üçÇ ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏°‡∏±‡∏Å‡∏õ‡∏∏‡πã‡∏¢"
    }
}

@app.get("/")
def health():
    return {"status": "Running", "model_loaded": model is not None}

@app.post("/predict")
async def predict(file: UploadFile = File(...)):
    if model is None:
        return {"error": "Model not loaded. Try restarting."}
    
    try:
        # 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        contents = await file.read()
        image = Image.open(io.BytesIO(contents)).convert("RGB")

        # =========================================================
        # üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á (Center Crop)
        # ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö‡∏£‡∏Å‡πÜ ‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ AI ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏Ç‡∏¢‡∏∞‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏û
        # =========================================================
        width, height = image.size
        new_dim = min(width, height)

        left = (width - new_dim)/2
        top = (height - new_dim)/2
        right = (width + new_dim)/2
        bottom = (height + new_dim)/2

        image = image.crop((left, top, right, bottom))
        # =========================================================
        
        # 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏†‡∏≤‡∏û‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•
        # (‡πÇ‡∏°‡πÄ‡∏î‡∏• God Mode ‡∏°‡∏µ Rescaling ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡∏£ 255)
        img_array = np.array(image.resize((224, 224)))
        img_array = np.expand_dims(img_array, axis=0)

        # 3. ‡πÉ‡∏´‡πâ AI ‡∏ó‡∏≤‡∏¢‡∏ú‡∏•
        prediction = model.predict(img_array, verbose=0)[0]
        class_index = int(np.argmax(prediction))
        confidence = float(prediction[class_index]) * 100
        class_name_en = class_names[class_index]

        # 4. ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
        info = trash_data.get(class_name_en, trash_data["trash-general"])

        # 5. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à (‡∏ñ‡πâ‡∏≤‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 45% ‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à)
        if confidence < 45.0:
            return {
                "prediction": "Unknown",
                "prediction_th": "‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à",
                "confidence": round(confidence, 2),
                "bin": "‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà",
                "advice": "‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏¢‡∏∞‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á ‡∏•‡∏≠‡∏á‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÜ ‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö"
            }

        return {
            "prediction": class_name_en,       # ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
            "prediction_th": info["th"],       # ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢
            "confidence": round(confidence, 2),
            "bin": info["bin"],                # ‡∏ñ‡∏±‡∏á‡∏™‡∏µ‡∏≠‡∏∞‡πÑ‡∏£
            "advice": info["advice"]           # ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏ó‡∏¥‡πâ‡∏á
        }
    except Exception as e:
        return {"error": str(e)}