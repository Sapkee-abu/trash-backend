from fastapi import FastAPI, File, UploadFile
from fastapi.middleware.cors import CORSMiddleware
import numpy as np
from PIL import Image
import tensorflow as tf
import io

app = FastAPI()

# 1. à¹€à¸›à¸´à¸” CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 2. à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥
print("à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥...")
try:
    # à¸•à¹‰à¸­à¸‡à¸¡à¸±à¹ˆà¸™à¹ƒà¸ˆà¸§à¹ˆà¸²à¹„à¸Ÿà¸¥à¹Œà¸Šà¸·à¹ˆà¸­ trash_classifier.keras à¸­à¸¢à¸¹à¹ˆà¸—à¸µà¹ˆà¹€à¸”à¸´à¸¡
    model = tf.keras.models.load_model("trash_classifier.keras")
    print("âœ… à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!")
except Exception as e:
    print(f"âŒ à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: {e}")

# 3. à¸Šà¸·à¹ˆà¸­à¸„à¸¥à¸²à¸ªà¹ƒà¸«à¸¡à¹ˆ (12 à¸›à¸£à¸°à¹€à¸ à¸— à¸ˆà¸²à¸ Dataset à¹ƒà¸«à¸¡à¹ˆ)
# à¸•à¹‰à¸­à¸‡à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©à¹€à¸›à¹Šà¸°à¹† à¸•à¸²à¸¡à¸—à¸µà¹ˆà¹‚à¸¡à¹€à¸”à¸¥à¹€à¸—à¸£à¸™à¸¡à¸²
class_names = [
    "battery",      # à¸–à¹ˆà¸²à¸™à¹„à¸Ÿà¸‰à¸²à¸¢
    "biological",   # à¸‚à¸¢à¸°à¹€à¸›à¸µà¸¢à¸/à¹€à¸¨à¸©à¸­à¸²à¸«à¸²à¸£
    "brown-glass",  # à¸‚à¸§à¸”à¹à¸à¹‰à¸§à¸ªà¸µà¸Šà¸²
    "cardboard",    # à¸¥à¸±à¸‡à¸à¸£à¸°à¸”à¸²à¸©
    "clothes",      # à¹€à¸ªà¸·à¹‰à¸­à¸œà¹‰à¸²à¹€à¸à¹ˆà¸²
    "green-glass",  # à¸‚à¸§à¸”à¹à¸à¹‰à¸§à¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§
    "metal",        # à¹‚à¸¥à¸«à¸°/à¸à¸£à¸°à¸›à¹‹à¸­à¸‡
    "paper",        # à¸à¸£à¸°à¸”à¸²à¸©
    "plastic",      # à¸žà¸¥à¸²à¸ªà¸•à¸´à¸ (à¸£à¸§à¸¡à¸–à¸¸à¸‡/à¸‚à¸§à¸”/à¸‹à¸­à¸‡à¸‚à¸™à¸¡)
    "shoes",        # à¸£à¸­à¸‡à¹€à¸—à¹‰à¸²à¹€à¸à¹ˆà¸²
    "trash",        # à¸‚à¸¢à¸°à¸—à¸±à¹ˆà¸§à¹„à¸›
    "white-glass"   # à¸‚à¸§à¸”à¹à¸à¹‰à¸§à¹ƒà¸ª
]

# 4. à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸³à¹à¸™à¸°à¸™à¸³ (Mapping 12 à¸›à¸£à¸°à¹€à¸ à¸— -> à¸¥à¸‡à¸–à¸±à¸‡)
def get_trash_info(class_name):
    # à¸à¸¥à¸¸à¹ˆà¸¡à¸‚à¸§à¸”à¹à¸à¹‰à¸§ (à¹„à¸¡à¹ˆà¸§à¹ˆà¸²à¸ªà¸µà¸­à¸°à¹„à¸£ à¸¥à¸‡à¸–à¸±à¸‡à¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™)
    if "glass" in class_name:
        return {
            "bin": "à¸–à¸±à¸‡à¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§ (à¸«à¸£à¸·à¸­à¸–à¸±à¸‡à¹à¸¢à¸à¹à¸à¹‰à¸§)",
            "advice": "ðŸ¾ à¸‚à¸§à¸”à¹à¸à¹‰à¸§: à¹€à¸—à¸™à¹‰à¸³à¸­à¸­à¸ à¸¥à¹‰à¸²à¸‡à¹ƒà¸«à¹‰à¸ªà¸°à¸­à¸²à¸” à¸£à¸°à¸§à¸±à¸‡à¹à¸•à¸à¸•à¸­à¸™à¸—à¸´à¹‰à¸‡"
        }
    
    # à¸à¸¥à¸¸à¹ˆà¸¡à¸à¸£à¸°à¸”à¸²à¸©
    if class_name in ["cardboard", "paper"]:
        return {
            "bin": "à¸–à¸±à¸‡à¸ªà¸µà¹€à¸«à¸¥à¸·à¸­à¸‡ à¸«à¸£à¸·à¸­ à¸™à¹‰à¸³à¹€à¸‡à¸´à¸™ (à¸£à¸µà¹„à¸‹à¹€à¸„à¸´à¸¥)",
            "advice": "ðŸ“¦ à¸à¸£à¸°à¸”à¸²à¸©/à¸¥à¸±à¸‡: à¸žà¸±à¸šà¹ƒà¸«à¹‰à¹à¸šà¸™ à¸­à¸¢à¹ˆà¸²à¹ƒà¸«à¹‰à¹€à¸›à¸µà¸¢à¸à¸™à¹‰à¸³à¸«à¸£à¸·à¸­à¹€à¸›à¸·à¹‰à¸­à¸™à¸„à¸£à¸²à¸šà¸¡à¸±à¸™"
        }
    
    # à¸à¸¥à¸¸à¹ˆà¸¡à¸žà¸¥à¸²à¸ªà¸•à¸´à¸à¹à¸¥à¸°à¹‚à¸¥à¸«à¸°
    if class_name in ["metal", "plastic"]:
        return {
            "bin": "à¸–à¸±à¸‡à¸ªà¸µà¹€à¸«à¸¥à¸·à¸­à¸‡ (à¸£à¸µà¹„à¸‹à¹€à¸„à¸´à¸¥)",
            "advice": "â™»ï¸ à¸£à¸µà¹„à¸‹à¹€à¸„à¸´à¸¥à¹„à¸”à¹‰: à¹€à¸—à¹€à¸¨à¸©à¸­à¸²à¸«à¸²à¸£/à¸™à¹‰à¸³à¸­à¸­à¸à¹ƒà¸«à¹‰à¸«à¸¡à¸” (à¸‹à¸­à¸‡à¸‚à¸™à¸¡à¸—à¸´à¹‰à¸‡à¸£à¸§à¸¡à¹„à¸”à¹‰à¹€à¸¥à¸¢)"
        }
    
    # à¸‚à¸¢à¸°à¸­à¸±à¸™à¸•à¸£à¸²à¸¢
    if class_name == "battery":
        return {
            "bin": "à¸–à¸±à¸‡à¸ªà¸µà¹à¸”à¸‡ (à¸‚à¸¢à¸°à¸­à¸±à¸™à¸•à¸£à¸²à¸¢)",
            "advice": "â›” à¸­à¸±à¸™à¸•à¸£à¸²à¸¢!: à¸«à¹‰à¸²à¸¡à¸—à¸´à¹‰à¸‡à¸£à¸§à¸¡à¸à¸±à¸šà¸‚à¸¢à¸°à¸­à¸·à¹ˆà¸™ à¹à¸¢à¸à¹ƒà¸ªà¹ˆà¸–à¸¸à¸‡à¹à¸”à¸‡à¸«à¸£à¸·à¸­à¸ˆà¸¸à¸”à¸£à¸±à¸šà¸—à¸´à¹‰à¸‡à¸‚à¸¢à¸°à¸žà¸´à¸©"
        }

    # à¸‚à¸¢à¸°à¹€à¸›à¸µà¸¢à¸
    if class_name == "biological":
        return {
            "bin": "à¸–à¸±à¸‡à¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§ (à¸‚à¸¢à¸°à¸­à¸´à¸™à¸—à¸£à¸µà¸¢à¹Œ)",
            "advice": "ðŸ‚ à¸‚à¸¢à¸°à¹€à¸›à¸µà¸¢à¸: à¸—à¸´à¹‰à¸‡à¸¥à¸‡à¸”à¸´à¸™à¸«à¸¡à¸±à¸à¸›à¸¸à¹‹à¸¢à¹„à¸”à¹‰ à¸«à¸£à¸·à¸­à¹à¸¢à¸à¸—à¸´à¹‰à¸‡à¸–à¸±à¸‡à¸‚à¸¢à¸°à¹€à¸›à¸µà¸¢à¸"
        }

    # à¸‚à¸¢à¸°à¸—à¸±à¹ˆà¸§à¹„à¸› (à¹€à¸ªà¸·à¹‰à¸­à¸œà¹‰à¸², à¸£à¸­à¸‡à¹€à¸—à¹‰à¸², à¸‚à¸¢à¸°à¸­à¸·à¹ˆà¸™à¹†)
    return {
        "bin": "à¸–à¸±à¸‡à¸ªà¸µà¸™à¹‰à¸³à¹€à¸‡à¸´à¸™ à¸«à¸£à¸·à¸­ à¸—à¸±à¹ˆà¸§à¹„à¸›",
        "advice": "ðŸ—‘ï¸ à¸‚à¸¢à¸°à¸—à¸±à¹ˆà¸§à¹„à¸›: à¸«à¸²à¸à¸ªà¸ à¸²à¸žà¸”à¸µà¸šà¸£à¸´à¸ˆà¸²à¸„à¹„à¸”à¹‰ à¸«à¸²à¸à¸žà¸±à¸‡à¹ƒà¸«à¹‰à¸—à¸´à¹‰à¸‡à¸–à¸±à¸‡à¸‚à¸¢à¸°à¸—à¸±à¹ˆà¸§à¹„à¸›"
    }

@app.get("/")
def health():
    return {"status": "API is running (12 Classes Model)"}

@app.post("/predict")
async def predict(file: UploadFile = File(...)):
    try:
        contents = await file.read()
        image = Image.open(io.BytesIO(contents)).convert("RGB")
        
        # Preprocessing
        image = image.resize((224, 224))
        img_array = np.array(image)
        
        # ðŸš¨ à¸ªà¸³à¸„à¸±à¸à¸¡à¸²à¸: à¹‚à¸¡à¹€à¸”à¸¥à¹ƒà¸«à¸¡à¹ˆà¹€à¸—à¸£à¸™à¸”à¹‰à¸§à¸¢à¸à¸²à¸£à¸«à¸²à¸£ 255 à¸•à¹‰à¸­à¸‡à¸«à¸²à¸£à¸”à¹‰à¸§à¸¢!
        img_array = img_array / 255.0  
        
        img_array = np.expand_dims(img_array, axis=0)

        # à¸—à¸³à¸™à¸²à¸¢à¸œà¸¥
        prediction = model.predict(img_array)[0]
        class_index = int(np.argmax(prediction))
        confidence = float(prediction[class_index]) * 100
        
        # à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ index à¹€à¸à¸´à¸™
        if class_index >= len(class_names):
            class_name = "trash"
        else:
            class_name = class_names[class_index]

        print(f"Prediction: {class_name} ({confidence:.2f}%)")

        # Threshold à¸•à¸±à¸”à¸„à¸§à¸²à¸¡à¸¡à¸±à¹ˆà¸™à¹ƒà¸ˆà¸•à¹ˆà¸³ (à¸›à¸£à¸±à¸šà¹€à¸›à¹‡à¸™ 50% à¸žà¸­à¸ªà¸³à¸«à¸£à¸±à¸š 12 à¸„à¸¥à¸²à¸ª)
        if confidence < 50.0:
            return {
                "prediction": "Unknown",
                "confidence": round(confidence, 2),
                "bin": "à¹„à¸¡à¹ˆà¹à¸™à¹ˆà¹ƒà¸ˆ",
                "advice": "à¸ à¸²à¸žà¹„à¸¡à¹ˆà¸Šà¸±à¸” à¸«à¸£à¸·à¸­à¹€à¸›à¹‡à¸™à¸‚à¸¢à¸°à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸ˆà¸±à¸ à¸¥à¸­à¸‡à¸–à¹ˆà¸²à¸¢à¹ƒà¸«à¸¡à¹ˆà¹ƒà¸à¸¥à¹‰à¹† à¸„à¸£à¸±à¸š",
                "top3": []
            }

        # à¸”à¸¶à¸‡à¸„à¸³à¹à¸™à¸°à¸™à¸³
        info = get_trash_info(class_name)

        # à¸ˆà¸±à¸” Top 3
        all_predictions = []
        for i, prob in enumerate(prediction):
            all_predictions.append({
                "class": class_names[i],
                "confidence": round(float(prob * 100), 2)
            })
        top3 = sorted(all_predictions, key=lambda x: x["confidence"], reverse=True)[:3]

        return {
            "prediction": class_name,
            "confidence": round(confidence, 2),
            "bin": info["bin"],
            "advice": info["advice"],
            "top3": top3
        }

    except Exception as e:
        print(f"Error: {e}")
        return {"error": str(e)}