import os
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î RAM
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'
os.environ['OMP_NUM_THREADS'] = '1'

from fastapi import FastAPI, File, UploadFile
from fastapi.middleware.cors import CORSMiddleware
import numpy as np
from PIL import Image
import tensorflow as tf
import io

app = FastAPI()

# ‡πÄ‡∏õ‡∏¥‡∏î CORS ‡πÉ‡∏´‡πâ Frontend ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# =========================================================
# 1. ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• (HEXA-FUSION VERSION)
# =========================================================
model = None
# ‚ö†Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å Colab ‡πÄ‡∏õ‡πä‡∏∞‡πÜ
MODEL_FILENAME = "trash_classifier_hexafusion.keras"

print(f"‚è≥ Loading {MODEL_FILENAME}...")
try:
    model = tf.keras.models.load_model(MODEL_FILENAME, compile=False)
    print("‚úÖ Model Loaded Successfully!")
except Exception as e:
    print(f"‚ùå Error loading model: {e}")

# =========================================================
# 2. ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ 20 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ A-Z)
# =========================================================
class_names = [
    "battery",          # 0. ‡∏ñ‡πà‡∏≤‡∏ô
    "brown-glass",      # 1. ‡πÅ‡∏Å‡πâ‡∏ß‡∏™‡∏µ‡∏ä‡∏≤
    "cardboard",        # 2. ‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©
    "carton-drink",     # 3. ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏°/UHT (VN Style)
    "cigarette",        # 4. ‡∏Å‡πâ‡∏ô‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà
    "clothes",          # 5. ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤
    "e-waste",          # 6. ‡∏Ç‡∏¢‡∏∞‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå (‡∏´‡∏±‡∏ß‡∏ä‡∏≤‡∏£‡πå‡∏à/‡∏™‡∏≤‡∏¢‡πÑ‡∏ü)
    "food-waste",       # 7. ‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (Organic/‡πÄ‡∏ô‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢)
    "glass",            # 8. ‡πÅ‡∏Å‡πâ‡∏ß‡∏£‡∏ß‡∏°
    "green-glass",      # 9. ‡πÅ‡∏Å‡πâ‡∏ß‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    "metal-can",        # 10. ‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á
    "paper",            # 11. ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©
    "plastic-bag",      # 12. ‡∏ñ‡∏∏‡∏á‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å (‡∏ñ‡∏∏‡∏á‡∏´‡∏π‡∏´‡∏¥‡πâ‡∏ß/‡∏ñ‡∏∏‡∏á‡∏Ç‡∏¢‡∏∞)
    "plastic-bottle",   # 13. ‡∏Ç‡∏ß‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å (‡∏£‡∏ß‡∏°‡∏Ç‡∏ß‡∏î‡∏ó‡∏∂‡∏ö)
    "plastic-cup",      # 14. ‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å (‡πÅ‡∏Å‡πâ‡∏ß‡∏Å‡∏≤‡πÅ‡∏ü/‡∏ä‡∏≤‡∏ô‡∏°)
    "shoes",            # 15. ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤
    "spray-cans",       # 16. ‡∏™‡πÄ‡∏õ‡∏£‡∏¢‡πå
    "styrofoam",        # 17. ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÇ‡∏ü‡∏° (‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏ß)
    "trash-general",    # 18. ‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    "white-glass"       # 19. ‡πÅ‡∏Å‡πâ‡∏ß‡πÉ‡∏™
]

# =========================================================
# 3. ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (Smart Advice)
# =========================================================
trash_data = {
    # ‚ö° ‡∏Å‡∏•‡∏∏‡πà‡∏° E-Waste
    "e-waste": {
        "th": "‡∏Ç‡∏¢‡∏∞‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå/‡∏™‡∏≤‡∏¢‡πÑ‡∏ü", 
        "bin": "üî¥ ‡∏ñ‡∏±‡∏á‡πÅ‡∏î‡∏á (‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢)", 
        "advice": "‚õî ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏°‡∏µ‡∏™‡∏≤‡∏£‡πÇ‡∏•‡∏´‡∏∞‡∏´‡∏ô‡∏±‡∏Å ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡∏£‡∏ß‡∏°‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡∏™‡πà‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö E-Waste ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏Å‡πà‡∏≤"
    },
    
    # üçÇ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å (‡∏à‡∏≤‡∏Å Organic Dataset)
    "food-waste": {
        "th": "‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πâ", 
        "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å)", 
        "advice": "üçÇ ‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡πÅ‡∏Å‡∏á‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏°‡∏±‡∏Å‡∏õ‡∏∏‡πã‡∏¢ (‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡∏õ‡∏ô‡∏Å‡∏±‡∏ö‡∏Ç‡∏¢‡∏∞‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)"
    },

    # üåè ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢ (‡∏à‡∏≤‡∏Å VN Dataset)
    "styrofoam": {
        "th": "‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÇ‡∏ü‡∏°/‡∏ñ‡πâ‡∏ß‡∏¢‡πÇ‡∏ü‡∏°", 
        "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)", 
        "advice": "‚õî ‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏•‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡∏¢‡∏≤‡∏Å! ‡πÄ‡∏ó‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏≠‡∏Å ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ö‡∏≤‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
    },
    "carton-drink": {
        "th": "‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏°/‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "‚ôªÔ∏è ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏¥‡πâ‡∏á: ‡∏î‡∏∂‡∏á‡∏´‡∏•‡∏≠‡∏î‡∏≠‡∏≠‡∏Å -> ‡∏ï‡∏±‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á -> ‡∏•‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≥ -> ‡∏ï‡∏≤‡∏Å‡πÅ‡∏´‡πâ‡∏á -> ‡∏û‡∏±‡∏ö‡πÅ‡∏ö‡∏ô"
    },
    "plastic-cup": {
        "th": "‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å/‡πÅ‡∏Å‡πâ‡∏ß‡∏ä‡∏≤‡∏ô‡∏°", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "ü•§ ‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏≠‡∏≠‡∏Å ‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î (‡∏ù‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏≠‡∏î‡∏°‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡∏ó‡∏¥‡πâ‡∏á)"
    },

    # üß¥ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô (Household)
    "plastic-bottle": {
        "th": "‡∏Ç‡∏ß‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å (‡πÉ‡∏™/‡∏Ç‡∏∏‡πà‡∏ô)", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "‚ôªÔ∏è ‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å ‡∏ö‡∏µ‡∏ö‡∏Ç‡∏ß‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ô (‡∏Ç‡∏ß‡∏î‡πÅ‡∏ä‡∏°‡∏û‡∏π/‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤‡∏Å‡πá‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô)"
    },
    "plastic-bag": {
        "th": "‡∏ñ‡∏∏‡∏á‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å/‡∏ñ‡∏∏‡∏á‡∏´‡∏π‡∏´‡∏¥‡πâ‡∏ß", 
        "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)", 
        "advice": "üóëÔ∏è ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡∏°‡∏±‡∏ô‡πÅ‡∏Å‡∏á‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ñ‡∏∏‡∏á‡∏¢‡∏∑‡∏î‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏™‡πà‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ '‡∏ß‡∏ô' ‡πÑ‡∏î‡πâ)"
    },

    # üî¥ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ
    "spray-cans": {"th": "‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á‡∏™‡πÄ‡∏õ‡∏£‡∏¢‡πå", "bin": "üî¥ ‡∏ñ‡∏±‡∏á‡πÅ‡∏î‡∏á", "advice": "‚õî ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏à‡∏≤‡∏∞/‡πÄ‡∏ú‡∏≤ ‡πÅ‡∏¢‡∏Å‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢"},
    "battery": {"th": "‡∏ñ‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏â‡∏≤‡∏¢", "bin": "üî¥ ‡∏ñ‡∏±‡∏á‡πÅ‡∏î‡∏á", "advice": "‚õî ‡πÅ‡∏¢‡∏Å‡πÉ‡∏™‡πà‡∏Ç‡∏ß‡∏î‡∏õ‡∏¥‡∏î‡∏ù‡∏≤ ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡∏£‡∏ß‡∏°"},
    "cigarette": {"th": "‡∏Å‡πâ‡∏ô‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà", "bin": "‚ö´ ‡∏Ç‡∏¢‡∏∞‡∏û‡∏¥‡∏©", "advice": "üö¨ ‡∏î‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏¥‡∏ó ‡πÉ‡∏™‡πà‡∏Ç‡∏ß‡∏î‡πÅ‡∏¢‡∏Å‡∏ó‡∏¥‡πâ‡∏á"},

    # üü° ‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    "metal-can": {"th": "‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á", "advice": "‡∏ö‡∏µ‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏¥‡πâ‡∏á"},
    "cardboard": {"th": "‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©", "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á", "advice": "‡∏Å‡∏£‡∏µ‡∏î‡πÄ‡∏ó‡∏õ‡∏≠‡∏≠‡∏Å ‡∏û‡∏±‡∏ö‡πÅ‡∏ö‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å"},
    "paper": {"th": "‡πÄ‡∏®‡∏©‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©", "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á", "advice": "‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡∏Ñ‡∏£‡∏≤‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£"},
    "glass": {"th": "‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß", "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß)", "advice": "‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏ï‡∏Å"},
    "brown-glass": {"th": "‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß‡∏™‡∏µ‡∏ä‡∏≤", "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß)", "advice": "‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î"},
    "green-glass": {"th": "‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß)", "advice": "‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î"},
    "white-glass": {"th": "‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß‡πÉ‡∏™", "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß)", "advice": "‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î"},

    # üîµ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    "trash-general": {"th": "‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", "advice": "‡∏Ç‡∏¢‡∏∞‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å/‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô/‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"},
    "shoes": {"th": "‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤", "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", "advice": "‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ ‡∏û‡∏±‡∏á‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"},
    "clothes": {"th": "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤", "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", "advice": "‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏≥‡∏ú‡πâ‡∏≤‡∏Ç‡∏µ‡πâ‡∏£‡∏¥‡πâ‡∏ß"}
}

@app.get("/")
def health():
    return {"status": "Running", "model": "Hexa-Fusion God Mode"}

@app.post("/predict")
async def predict(file: UploadFile = File(...)):
    if model is None: return {"error": "Model not loaded"}
    
    try:
        # 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ
        image = Image.open(io.BytesIO(await file.read())).convert("RGB")
        
        # 2. Center Crop (‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö)
        w, h = image.size
        dim = min(w, h)
        image = image.crop(((w-dim)/2, (h-dim)/2, (w+dim)/2, (h+dim)/2))
        
        # 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏†‡∏≤‡∏û‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•
        img_arr = np.array(image.resize((224, 224)))
        img_arr = np.expand_dims(img_arr, axis=0)

        # 4. ‡∏ó‡∏≤‡∏¢‡∏ú‡∏•
        pred = model.predict(img_arr, verbose=0)[0]
        idx = int(np.argmax(pred))
        conf = float(pred[idx]) * 100
        label_en = class_names[idx]

        # 5. Threshold (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à 65%)
        if conf < 65.0:
            return {
                "prediction": "Unknown",
                "prediction_th": "‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à",
                "confidence": round(conf, 2),
                "bin": "‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà",
                "advice": "‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏¢‡∏∞‡∏ó‡∏µ‡πà AI ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‡∏•‡∏≠‡∏á‡∏Ç‡∏¢‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö"
            }

        info = trash_data.get(label_en, trash_data["trash-general"])
        
        return {
            "prediction": label_en,
            "prediction_th": info["th"],
            "confidence": round(conf, 2),
            "bin": info["bin"],
            "advice": info["advice"]
        }
    except Exception as e:
        return {"error": str(e)}