import os
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î RAM ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î Log ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'
os.environ['OMP_NUM_THREADS'] = '1'

from fastapi import FastAPI, File, UploadFile
from fastapi.middleware.cors import CORSMiddleware
import numpy as np
from PIL import Image
import tensorflow as tf
import io

app = FastAPI()

# ‡πÄ‡∏õ‡∏¥‡∏î CORS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Frontend (‡πÄ‡∏ß‡πá‡∏ö/‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ API ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# =========================================================
# 1. ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• (Tri-Fusion Model)
# =========================================================
model = None
MODEL_FILENAME = "trash_classifier_trifusion.keras"

print(f"‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• {MODEL_FILENAME} ...")
try:
    model = tf.keras.models.load_model(MODEL_FILENAME, compile=False)
    print("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!")
except Exception as e:
    print(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•: {e}")
    print("‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå .keras ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà")

# =========================================================
# 2. ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏∞ 20 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Class Names)
# =========================================================
# ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å! ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ A-Z ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ó‡∏£‡∏ô‡πÉ‡∏ô Colab ‡πÄ‡∏õ‡πä‡∏∞‡πÜ
class_names = [
    "battery",          # 0. ‡∏ñ‡πà‡∏≤‡∏ô
    "brown-glass",      # 1. ‡πÅ‡∏Å‡πâ‡∏ß‡∏™‡∏µ‡∏ä‡∏≤
    "cardboard",        # 2. ‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©
    "carton-drink",     # 3. ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏°/UHT
    "cigarette",        # 4. ‡∏Å‡πâ‡∏ô‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà
    "clothes",          # 5. ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤
    "e-waste",          # 6. ‡∏Ç‡∏¢‡∏∞‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå (‚ö° ‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà!)
    "food-waste",       # 7. ‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å
    "glass",            # 8. ‡πÅ‡∏Å‡πâ‡∏ß‡∏£‡∏ß‡∏°
    "green-glass",      # 9. ‡πÅ‡∏Å‡πâ‡∏ß‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    "metal-can",        # 10. ‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á
    "paper",            # 11. ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©
    "plastic-bag",      # 12. ‡∏ñ‡∏∏‡∏á‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å
    "plastic-bottle",   # 13. ‡∏Ç‡∏ß‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å
    "plastic-cup",      # 14. ‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å
    "shoes",            # 15. ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤
    "spray-cans",       # 16. ‡∏™‡πÄ‡∏õ‡∏£‡∏¢‡πå
    "styrofoam",        # 17. ‡πÇ‡∏ü‡∏°
    "trash-general",    # 18. ‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    "white-glass"       # 19. ‡πÅ‡∏Å‡πâ‡∏ß‡πÉ‡∏™
]

# =========================================================
# 3. ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (Advice Database)
# =========================================================
trash_data = {
    # --- ‚ö° ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå (New!) ---
    "e-waste": {
        "th": "‡∏Ç‡∏¢‡∏∞‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå/‡∏™‡∏≤‡∏¢‡πÑ‡∏ü", 
        "bin": "üî¥ ‡∏ñ‡∏±‡∏á‡πÅ‡∏î‡∏á (‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢)", 
        "advice": "‚õî ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡∏£‡∏ß‡∏°‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î! ‡∏°‡∏µ‡∏™‡∏≤‡∏£‡πÇ‡∏•‡∏´‡∏∞‡∏´‡∏ô‡∏±‡∏Å ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏™‡πà‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏Ç‡∏¢‡∏∞‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå (E-Waste) ‡∏´‡∏£‡∏∑‡∏≠‡∏ù‡∏≤‡∏Å‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡πÑ‡∏õ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏¨‡∏≤‡∏Ø ‡∏£‡∏±‡∏Å‡∏©‡πå‡πÇ‡∏•‡∏Å"
    },

    # --- üî¥ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ (Dangerous) ---
    "spray-cans": {
        "th": "‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á‡∏™‡πÄ‡∏õ‡∏£‡∏¢‡πå", 
        "bin": "üî¥ ‡∏ñ‡∏±‡∏á‡πÅ‡∏î‡∏á (‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢)", 
        "advice": "‚õî ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏à‡∏≤‡∏∞ ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏∏‡∏ö ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ú‡∏≤ ‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡πÉ‡∏™‡πà‡∏ñ‡∏∏‡∏á‡πÅ‡∏î‡∏á"
    },
    "battery": {
        "th": "‡∏ñ‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏â‡∏≤‡∏¢/‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà", 
        "bin": "üî¥ ‡∏ñ‡∏±‡∏á‡πÅ‡∏î‡∏á (‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢)", 
        "advice": "‚õî ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏°‡∏µ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡πÑ‡∏î‡πâ ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ç‡∏¢‡∏∞‡∏≠‡∏∑‡πà‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡πÉ‡∏™‡πà‡∏Ç‡∏ß‡∏î‡∏õ‡∏¥‡∏î‡∏ù‡∏≤"
    },
    "cigarette": {
        "th": "‡∏Å‡πâ‡∏ô‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà", 
        "bin": "‚ö´ ‡∏Ç‡∏¢‡∏∞‡∏û‡∏¥‡∏©/‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", 
        "advice": "üö¨ ‡∏î‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏¥‡∏ó! ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏™‡πà‡∏Ç‡∏ß‡∏î‡πÅ‡∏¢‡∏Å‡∏ó‡∏¥‡πâ‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡∏≤‡∏£‡∏û‡∏¥‡∏©‡∏•‡∏á‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ (‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡∏•‡∏á‡∏ó‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥)"
    },

    # --- üü° ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• (Recycle) ---
    "carton-drink": {
        "th": "‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏°/‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ (UHT)", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "‚ôªÔ∏è ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏¥‡πâ‡∏á: ‡∏ï‡∏±‡∏î-‡∏•‡πâ‡∏≤‡∏á-‡∏ï‡∏≤‡∏Å-‡∏û‡∏±‡∏ö‡πÅ‡∏ö‡∏ô ‡∏™‡πà‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÑ‡∏î‡πâ"
    },
    "metal-can": {
        "th": "‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "‚ôªÔ∏è ‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏µ‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà"
    },
    "plastic-bottle": {
        "th": "‡∏Ç‡∏ß‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡πÉ‡∏™ (PET)", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "‚ôªÔ∏è ‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å ‡∏ö‡∏µ‡∏ö‡∏Ç‡∏ß‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ô (‡πÅ‡∏¢‡∏Å‡∏ù‡∏≤‡∏Å‡∏±‡∏ö‡∏Ç‡∏ß‡∏î‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ)"
    },
    "plastic-cup": {
        "th": "‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "ü•§ ‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏≠‡∏≠‡∏Å ‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î (‡∏´‡∏•‡∏≠‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)"
    },
    "cardboard": {
        "th": "‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©/‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "üì¶ ‡∏Å‡∏£‡∏µ‡∏î‡πÄ‡∏ó‡∏õ‡∏Å‡∏≤‡∏ß‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥"
    },
    "paper": {
        "th": "‡πÄ‡∏®‡∏©‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©/‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", 
        "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)", 
        "advice": "üìÑ ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏ñ‡∏∏‡∏á ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡∏Ñ‡∏£‡∏≤‡∏ö‡∏°‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£"
    },

    # --- üü¢ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡∏ß (Glass) ---
    "brown-glass": {
        "th": "‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß‡∏™‡∏µ‡∏ä‡∏≤", 
        "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß)", 
        "advice": "üçæ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏™‡πà‡∏á‡∏Ç‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏µ"
    },
    "green-glass": {
        "th": "‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", 
        "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß)", 
        "advice": "üçæ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏ï‡∏Å"
    },
    "white-glass": {
        "th": "‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß‡πÉ‡∏™", 
        "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß)", 
        "advice": "üçæ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏ï‡∏Å (‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏±‡∏ö‡∏™‡∏ô‡∏Å‡∏±‡∏ö‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å ‡∏•‡∏≠‡∏á‡∏ö‡∏µ‡∏ö‡∏î‡∏π‡∏ñ‡πâ‡∏≤‡πÅ‡∏Ç‡πá‡∏á‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡∏ß)"
    },
    "glass": {
        "th": "‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß‡∏£‡∏ß‡∏°/‡πÄ‡∏®‡∏©‡πÅ‡∏Å‡πâ‡∏ß", 
        "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß)", 
        "advice": "‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏ï‡∏Å! (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏®‡∏©‡πÅ‡∏Å‡πâ‡∏ß‡πÅ‡∏ï‡∏Å ‡πÉ‡∏´‡πâ‡∏´‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏´‡∏ô‡∏≤‡πÜ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ß‡πà‡∏≤ '‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏Å‡πâ‡∏ß‡πÅ‡∏ï‡∏Å')"
    },

    # --- üîµ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General) ---
    "styrofoam": {
        "th": "‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÇ‡∏ü‡∏°/‡πÄ‡∏®‡∏©‡πÇ‡∏ü‡∏°", 
        "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)", 
        "advice": "‚õî ‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏•‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ! ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ú‡∏≤(‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡πä‡∏≤‡∏ã‡∏û‡∏¥‡∏©) ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
    },
    "plastic-bag": {
        "th": "‡∏ñ‡∏∏‡∏á‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å/‡∏ã‡∏≠‡∏á‡∏Ç‡∏ô‡∏°", 
        "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)", 
        "advice": "üóëÔ∏è ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ñ‡∏∏‡∏á‡∏¢‡∏∑‡∏î‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏™‡πà‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ '‡∏ß‡∏ô' ‡πÑ‡∏î‡πâ)"
    },
    "trash-general": {
        "th": "‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", 
        "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)", 
        "advice": "üóëÔ∏è ‡∏Ç‡∏¢‡∏∞‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å/‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô/‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
    },
    "shoes": {
        "th": "‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤", 
        "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)", 
        "advice": "üëü ‡∏ñ‡πâ‡∏≤‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡∏û‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
    },
    "clothes": {
        "th": "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤", 
        "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)", 
        "advice": "üëï ‡∏ñ‡πâ‡∏≤‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏ó‡∏≥‡∏ú‡πâ‡∏≤‡∏Ç‡∏µ‡πâ‡∏£‡∏¥‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
    },
    
    # --- üçÇ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å (Organic) ---
    "food-waste": {
        "th": "‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å", 
        "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å)", 
        "advice": "üçÇ ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Å‡∏á‡∏≠‡∏≠‡∏Å ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏°‡∏±‡∏Å‡∏õ‡∏∏‡πã‡∏¢ (‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡∏õ‡∏ô‡∏Å‡∏±‡∏ö‡∏Ç‡∏¢‡∏∞‡πÅ‡∏´‡πâ‡∏á)"
    }
}

@app.get("/")
def health_check():
    return {"status": "Running", "model": MODEL_FILENAME}

# =========================================================
# 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏• (Prediction Logic)
# =========================================================
@app.post("/predict")
async def predict(file: UploadFile = File(...)):
    if model is None:
        return {"error": "Model not loaded. Please restart the space."}
    
    try:
        # 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
        contents = await file.read()
        image = Image.open(io.BytesIO(contents)).convert("RGB")

        # ---------------------------------------------------------
        # üéØ Center Crop Logic
        # ‡∏ï‡∏±‡∏î‡∏†‡∏≤‡∏û‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö‡πÇ‡∏ï‡πä‡∏∞/‡∏°‡∏∑‡∏≠‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏Å ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
        # ---------------------------------------------------------
        width, height = image.size
        new_dim = min(width, height)

        left = (width - new_dim)/2
        top = (height - new_dim)/2
        right = (width + new_dim)/2
        bottom = (height + new_dim)/2

        image = image.crop((left, top, right, bottom))
        # ---------------------------------------------------------
        
        # 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏†‡∏≤‡∏û‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏• (Resize & Array conversion)
        img_array = np.array(image.resize((224, 224)))
        img_array = np.expand_dims(img_array, axis=0)

        # 3. ‡πÉ‡∏´‡πâ AI ‡∏ó‡∏≤‡∏¢‡∏ú‡∏•
        prediction = model.predict(img_array, verbose=0)[0]
        
        # 4. ‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
        class_index = int(np.argmax(prediction))
        confidence = float(prediction[class_index]) * 100
        class_name_en = class_names[class_index]

        # 5. ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à (Threshold)
        # ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 55% ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ "‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à"
        if confidence < 55.0:
            return {
                "prediction": "Unknown",
                "prediction_th": "‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à",
                "confidence": round(confidence, 2),
                "bin": "‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà",
                "advice": "‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏¢‡∏∞‡∏ó‡∏µ‡πà AI ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß) ‡∏•‡∏≠‡∏á‡∏Ç‡∏¢‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÜ ‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö"
            }

        # 6. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å Database
        info = trash_data.get(class_name_en, trash_data["trash-general"])

        # ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
        return {
            "prediction": class_name_en,       # ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
            "prediction_th": info["th"],       # ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢
            "confidence": round(confidence, 2),# ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à %
            "bin": info["bin"],                # ‡∏ñ‡∏±‡∏á‡∏™‡∏µ‡∏≠‡∏∞‡πÑ‡∏£
            "advice": info["advice"]           # ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
        }

    except Exception as e:
        return {"error": str(e)}