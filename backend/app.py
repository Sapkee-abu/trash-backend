import os
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î RAM ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î Log ‡∏£‡∏Å‡πÜ ‡∏Ç‡∏≠‡∏á TensorFlow
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'
os.environ['OMP_NUM_THREADS'] = '1'

from fastapi import FastAPI, File, UploadFile
from fastapi.middleware.cors import CORSMiddleware
import numpy as np
from PIL import Image
import tensorflow as tf
import io

app = FastAPI()

# ‡πÄ‡∏õ‡∏¥‡∏î CORS ‡πÉ‡∏´‡πâ Frontend ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# =========================================================
# 1. ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• (EfficientNet-B3 Pro Version)
# =========================================================
model = None
# ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏Ç‡∏∂‡πâ‡∏ô Hugging Face ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
MODEL_FILENAME = "trash_classifier_b3_pro.keras" 

print(f"‚è≥ Loading {MODEL_FILENAME}...")
try:
    model = tf.keras.models.load_model(MODEL_FILENAME, compile=False)
    print("‚úÖ Model Loaded Successfully!")
except Exception as e:
    print(f"‚ùå Error loading model: {e}")

# =========================================================
# 2. ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ 20 Class (‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î)
# =========================================================
raw_class_names = [
    "battery",          # 0
    "brown-glass",      # 1
    "cardboard",        # 2
    "carton-drink",     # 3
    "cigarette",        # 4
    "clothes",          # 5
    "e-waste",          # 6
    "food-waste",       # 7
    "glass",            # 8
    "green-glass",      # 9
    "metal-can",        # 10
    "paper",            # 11
    "plastic-bag",      # 12
    "plastic-bottle",   # 13
    "plastic-cup",      # 14
    "shoes",            # 15
    "spray-cans",       # 16
    "styrofoam",        # 17
    "trash-general",    # 18
    "white-glass"       # 19
]

# =========================================================
# 3. ‡∏£‡∏∞‡∏ö‡∏ö Smart Categories (‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢)
# =========================================================
def get_trash_info(label):
    # üî¥ ‡∏Å‡∏•‡∏∏‡πà‡∏° 1: ‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ (‡∏£‡∏ß‡∏° Battery, E-waste, Spray, Cigarette)
    if label in ["battery", "e-waste", "spray-cans", "cigarette"]:
        return {
            "title": "‚õî ‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ (Hazardous)",
            "bin": "üî¥ ‡∏ñ‡∏±‡∏á‡πÅ‡∏î‡∏á (‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢)",
            "advice": "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå, ‡∏ñ‡πà‡∏≤‡∏ô, ‡∏™‡πÄ‡∏õ‡∏£‡∏¢‡πå: ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡∏£‡∏ß‡∏°‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î! ‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡πÉ‡∏™‡πà‡∏ñ‡∏∏‡∏á‡πÅ‡∏î‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏¢‡∏∞‡∏û‡∏¥‡∏©"
        }

    # üü° ‡∏Å‡∏•‡∏∏‡πà‡∏° 2: ‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å (‡∏£‡∏ß‡∏° Bottle, Cup)
    elif label in ["plastic-bottle", "plastic-cup"]:
        return {
            "title": "‚ôªÔ∏è ‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å ‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• (Plastic)",
            "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)",
            "advice": "‡∏Ç‡∏ß‡∏î‡∏ô‡πâ‡∏≥/‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥/‡∏Ç‡∏ß‡∏î‡πÅ‡∏ä‡∏°‡∏û‡∏π: ‡πÄ‡∏ó‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß‡∏≠‡∏≠‡∏Å ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•"
        }

    # üü° ‡∏Å‡∏•‡∏∏‡πà‡∏° 3: ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©/‡∏Å‡∏•‡πà‡∏≠‡∏á (‡∏£‡∏ß‡∏° Paper, Cardboard, Carton)
    elif label in ["paper", "cardboard", "carton-drink"]:
        return {
            "title": "‚ôªÔ∏è ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©/‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏° (Paper)",
            "bin": "üü° ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)",
            "advice": "‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏•‡∏±‡∏á/‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏°/‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©: ‡∏û‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡∏°‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)"
        }

    # üü° ‡∏Å‡∏•‡∏∏‡πà‡∏° 4: ‡πÇ‡∏•‡∏´‡∏∞/‡πÅ‡∏Å‡πâ‡∏ß (‡∏£‡∏ß‡∏° Metal, Glass)
    elif label in ["metal-can", "glass", "brown-glass", "green-glass", "white-glass"]:
        return {
            "title": "‚ôªÔ∏è ‡πÅ‡∏Å‡πâ‡∏ß/‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á (Glass/Metal)",
            "bin": "üü°/üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ñ‡∏±‡∏á‡πÅ‡∏¢‡∏Å‡πÅ‡∏Å‡πâ‡∏ß",
            "advice": "‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á: ‡∏ö‡∏µ‡∏ö‡πÅ‡∏ö‡∏ô / ‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß: ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏ï‡∏Å (‡∏ñ‡πâ‡∏≤‡πÅ‡∏ï‡∏Å‡πÉ‡∏´‡πâ‡∏´‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏´‡∏ô‡∏≤‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏¥‡πâ‡∏á)"
        }

    # üü¢ ‡∏Å‡∏•‡∏∏‡πà‡∏° 5: ‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å (Food Waste)
    elif label in ["food-waste"]:
        return {
            "title": "üçÇ ‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å/‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (Organic)",
            "bin": "üü¢ ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å)",
            "advice": "‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πâ: ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î ‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏°‡∏±‡∏Å‡∏õ‡∏∏‡πã‡∏¢‡πÑ‡∏î‡πâ (‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏∏‡∏á‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏•‡∏á‡πÑ‡∏õ)"
        }

    # üîµ ‡∏Å‡∏•‡∏∏‡πà‡∏° 6: ‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General) - ‡∏£‡∏ß‡∏°‡∏ñ‡∏∏‡∏á/‡πÇ‡∏ü‡∏°/‡∏ú‡πâ‡∏≤
    else:
        return {
            "title": "üóëÔ∏è ‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General Waste)",
            "bin": "üîµ ‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)",
            "advice": "‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô, ‡∏ñ‡∏∏‡∏á‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å, ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÇ‡∏ü‡∏°, ‡∏ã‡∏≠‡∏á‡∏Ç‡∏ô‡∏°: ‡πÉ‡∏´‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏ô‡∏µ‡πâ\n‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á: ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô 'Power Bank/‡∏ñ‡πà‡∏≤‡∏ô' ‡πÉ‡∏´‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏±‡∏á‡πÅ‡∏î‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"
        }

@app.get("/")
def health():
    return {"status": "Running", "model": "EfficientNet-B3 Pro"}

@app.post("/predict")
async def predict(file: UploadFile = File(...)):
    if model is None: return {"error": "Model not loaded"}
    
    try:
        # 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ
        image = Image.open(io.BytesIO(await file.read())).convert("RGB")
        
        # 2. Center Crop (‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏à‡∏±‡∏ï‡∏∏‡∏£‡∏±‡∏™)
        w, h = image.size
        dim = min(w, h)
        image = image.crop(((w-dim)/2, (h-dim)/2, (w+dim)/2, (h+dim)/2))
        
        # üî• 3. Resize ‡πÄ‡∏õ‡πá‡∏ô 300x300 (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö EfficientNet-B3!)
        img_arr = np.array(image.resize((300, 300)))
        img_arr = np.expand_dims(img_arr, axis=0)

        # 4. ‡∏ó‡∏≤‡∏¢‡∏ú‡∏•
        pred = model.predict(img_arr, verbose=0)[0]
        idx = int(np.argmax(pred))
        conf = float(pred[idx]) * 100
        raw_label = raw_class_names[idx]

        # 5. Threshold (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à)
        # ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ô‡∏µ‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏°‡∏≤‡∏Å ‡πÄ‡∏£‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà 60% ‡∏Å‡πá‡∏û‡∏≠ (‡∏ñ‡πâ‡∏≤‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏£‡∏π‡∏õ‡πÅ‡∏¢‡πà‡∏à‡∏£‡∏¥‡∏á‡πÜ)
        if conf < 60.0:
            return {
                "prediction": "Unknown",
                "prediction_th": "‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à (Try Again)",
                "confidence": round(conf, 2),
                "bin": "‚ùì ‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà",
                "advice": "‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î ‡∏´‡∏£‡∏∑‡∏≠ AI ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‡∏•‡∏≠‡∏á‡∏Ç‡∏¢‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö"
            }

        # 6. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
        info = get_trash_info(raw_label)
        
        return {
            "prediction": raw_label,       # ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏î‡∏π Log)
            "prediction_th": info["title"], # ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÇ‡∏ä‡∏ß‡πå User
            "confidence": round(conf, 2),
            "bin": info["bin"],
            "advice": info["advice"]
        }

    except Exception as e:
        return {"error": str(e)}